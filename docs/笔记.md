### Playlist Construction

VOD：Video on Demand 视频点播

```sh
#EXTM3U
#EXT-X-PLAYLIST-TYPE:VOD
#EXT-X-TARGETDURATION:10
#EXT-X-VERSION:4
#EXT-X-MEDIA-SEQUENCE:0
#EXTINF:10.0,
http://example.com/movie1/fileSequenceA.ts
#EXTINF:10.0,
http://example.com/movie1/fileSequenceB.ts
#EXTINF:10.0,
http://example.com/movie1/fileSequenceC.ts
#EXTINF:9.0,
http://example.com/movie1/fileSequenceD.ts
#EXT-X-ENDLIST
```

- EXTM3U：标记开头
- EXT-X-PLAYLIST-TYPE：标记信息流可变信息
  - EVENT：不能删除或修改，但可以新增
  - VCD：不能修改
- EXT-X-TARGETDURATION：单个媒体文件持续的最大时间，单位秒
- EXT-X-VERSION：协议版本
- EXT-X-MEDIA-SEQUENCE：标记当前视频从哪个片段开始播放
- EXTINF：记录每一段媒体文件的持续时间
- EXT-X-ENDLIST：标记结尾

三种模式：

1. VOD：点播模式，不允许修改，结尾有 EXT-X-ENDLIST
2. EVENT：类似于赛事直播，和普通直播的区别是可以看之前的内容，没有 EXT-X-ENDLIST 字段，结束后自动添加
3. 直播：没有 EXT-X-PLAYLIST-TYPE，每播一个文件 EXT-X-MEDIA-SEQUENCE 必须加一，同时删除播放过的媒体流



### Master Playlist

```sh
#EXTM3U
#EXT-X-STREAM-INF:BANDWIDTH=150000,RESOLUTION=416x234,CODECS="avc1.42e00a,mp4a.40.2"
http://example.com/low/index.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=240000,RESOLUTION=416x234,CODECS="avc1.42e00a,mp4a.40.2"
http://example.com/lo_mid/index.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=440000,RESOLUTION=416x234,CODECS="avc1.42e00a,mp4a.40.2"
http://example.com/hi_mid/index.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=640000,RESOLUTION=640x360,CODECS="avc1.42e00a,mp4a.40.2"
http://example.com/high/index.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=64000,CODECS="mp4a.40.5"
http://example.com/audio/index.m3u8
```

EXT-X-STREAM-INF：标记每一个 URL 的属性

其中 BANDWIDTH 是必填的，Int 类型，表示每个媒体文件的总体比特率的上限

表示不同清晰度选择的 m3u8 播放地址



### Transport Stream

名次解析：

- ES：(Elementary Stream) 基本码流，不分段的音频、视频或其他信息的连续码流。

- PES：把基本流ES分割成段，并加上相应头文件打包成形的打包基本码流
- TS：(Transport Stream) 传输流，将具有共同时间基准或独立时间基准的一个或多个PES组合（复合）而成的单一数据流（用于数据传输）

- PAT：(Program Association Table) 节目关联表
- PMT：(Program Map Table) 节目映射表

TS流是基于Packet的位流格式，每个包是188个字节（或204个字节，在188个字节后加上了16字节的CRC校验数据）



TS 分组格式

|                         名称                         |   [比特](https://zh.wikipedia.org/wiki/位元)数    |       描述       |                                                              |                                    |
| :--------------------------------------------------: | :-----------------------------------------------: | :--------------: | ------------------------------------------------------------ | ---------------------------------- |
|                  固定部分 （4字节）                  |                     同步字节                      |    sync byte     | 8                                                            | 0x47                               |
|                    传输错误指示位                    |          Transport Error Indicator (TEI)          |        1         | 发送时（调制前）值为0。接收方的解调器在无法成功解调（即使有前向纠错机制）TS分组内容时，将该位设置为1，表示该TS分组损坏。[[8\]](https://zh.wikipedia.org/wiki/MPEG2-TS#cite_note-Coolstf-10) |                                    |
|                  载荷单元开始指示位                  |           Payload Unit Start Indicator            |        1         | 负载单元起始标示符，一个完整的数据包开始时标记为1, 表示携带的是[PSI](https://zh.wikipedia.org/wiki/节目专用信息)或[PES](https://zh.wikipedia.org/w/index.php?title=Packetized_Elementary_Stream&action=edit&redlink=1)第一个包 |                                    |
|                      传输优先级                      |                Transport Priority                 |        1         | 值为1时，在相同PID的分组中具有更高的优先权。                 |                                    |
| [分组ID](https://zh.wikipedia.org/wiki/MPEG2-TS#PID) | [PID](https://zh.wikipedia.org/wiki/MPEG2-TS#PID) |        13        | 用于识别TS分组的ID。一个PID对应一种特定的PSI消息或者一个特定的PES。 |                                    |
|                     传输加扰控制                     |        Transport Scrambling control (TSC)         |        2         | 值为'00'时表示载荷未加密。其余值由具体系统定义。以[DVB](https://zh.wikipedia.org/wiki/DVB)的[CSA](https://zh.wikipedia.org/w/index.php?title=通用扰码算法&action=edit&redlink=1)[[9\]](https://zh.wikipedia.org/wiki/MPEG2-TS#cite_note-ETSI_TS_100289-11):8和[ATSC](https://zh.wikipedia.org/wiki/ATSC)的[DCS](https://zh.wikipedia.org/wiki/数据加密标准)为例：'01' = 保留 (供未来使用),'10' = 以奇数密钥加密'11' = 以偶数密钥加密 |                                    |
|                    适配域存在标志                    |              Adaptation field exist               |        2         | '00' = 保留 (供未来使用)'01' = 无适配域，仅有载荷'10' = 仅有适配域'11' = 适配域和载荷都存在 |                                    |
|                     连续性计数器                     |                Continuity counter                 |        4         | 取值为0x00到0x0F，循环。用于检查同一个PID的TS分组的连续性。每当一个TS分组中包含载荷时，该计数器加1。 |                                    |
|                       可选部分                       |                      适配域                       | Adaptation field | 0或更多                                                      | 当适配域存在标志为'10'或'11'时存在 |
| [载荷](https://zh.wikipedia.org/wiki/负载_(计算机))  |                   Payload Data                    |     0或更多      | 当适配域存在标志为'01'或'11'时存在                           |                                    |



解码过程

1. 获取 TS 中的 PAT



### hls.js



### 资料

[Apple Live Streaming](https://developer.apple.com/documentation/http_live_streaming)

[Media Source Extensions](https://developers.google.com/web/fundamentals/media/mse/basics)

[Wiki TS](https://zh.wikipedia.org/wiki/MPEG2-TS)

[TS 流基本概念](cnblogs.com/jiayayao/p/6832614.html)